# CLAUDE.md

This file provides guidance for Claude Code when working on the Rsync Studio project.

## Project Overview

Rsync Studio is a cross-platform (macOS + Linux) rsync management tool with two frontends: a desktop GUI (Tauri v2 + React + TypeScript + shadcn/ui + Tailwind CSS) and a terminal UI (ratatui + crossterm). Both share a common Rust core library.

## Workspace Structure

```
rsync-studio/
├── Cargo.toml              # Workspace root (resolver = "2")
├── crates/
│   ├── rsync-core/         # Shared library: all domain logic, models, traits, services, tests
│   └── rsync-commander/    # Terminal UI: ratatui + crossterm + clap
├── src-tauri/              # GUI crate: Tauri shell, commands, state management
│   ├── src/commands.rs     # Tauri IPC command handlers
│   ├── src/execution.rs    # TauriEventHandler (ExecutionEventHandler impl)
│   ├── src/state.rs        # AppState (Database + Arc<JobExecutor>)
│   ├── src/lib.rs          # Tauri app builder + setup
│   └── src/main.rs         # Entry point
└── src/                    # React frontend
    ├── components/         # UI components (jobs/, ui/)
    ├── hooks/              # React hooks (use-jobs.ts)
    ├── lib/                # Utilities (tauri.ts, command-preview.ts, defaults.ts)
    ├── pages/              # Page components (jobs, history, settings)
    └── types/              # TypeScript type definitions mirroring Rust models
```

## Key Commands

```bash
# Frontend
npm install                    # Install JS dependencies
npm run dev                    # Start Vite dev server (port 1420)
npm run build                  # TypeScript check + Vite build
npx tsc --noEmit               # TypeScript type-check only

# Rust
cargo build --workspace        # Build all crates
cargo test -p rsync-core       # Run all tests (191 tests)
cargo test -p rsync-core -- <test_name>  # Run specific test

# Tauri (GUI)
npm run tauri dev              # Dev mode with hot reload
npm run tauri build            # Production build

# TUI
cargo run -p rsync-commander         # Run the terminal UI
cargo run -p rsync-commander -- list # List jobs (non-interactive)
cargo run -p rsync-commander -- run <job-id>  # Run single job (non-interactive)
cargo build -p rsync-commander --release      # Release build
```

## Architecture Patterns

### Trait-based Dependency Injection
All domain logic uses traits for testability:
- `RsyncClient` — rsync execution abstraction
- `FileSystem` — filesystem operations abstraction
- `JobRepository`, `InvocationRepository`, `SnapshotRepository` — data persistence

Production implementations use real processes/SQLite. Tests use in-memory fakes (`TestRsyncClient`, `TestFileSystem`).

### ExecutionEventHandler (Frontend Abstraction)
Job execution orchestration (log writing, statistics, snapshots) lives in `rsync-core`'s `JobExecutor`. The `ExecutionEventHandler` trait decouples it from any frontend: GUI implements with `AppHandle.emit()`, TUI implements with `mpsc::Sender`. If you modify execution behavior, change `job_executor.rs` — not the frontend wrappers.

### Shared Command Builder
`crates/rsync-core/src/services/command_builder.rs` builds rsync argument vectors. Both the Rust `ProcessRsyncClient` and the TypeScript `src/lib/command-preview.ts` mirror this logic. If you modify rsync flag handling, update both.

### Frontend-Backend Type Alignment
TypeScript types in `src/types/` must stay aligned with Rust models in `crates/rsync-core/src/models/`. The Tauri IPC layer serializes Rust structs as JSON, and the frontend deserializes into these TypeScript types.

### Form State Management
Job forms use `useReducer` with the full `JobDefinition` as state. The reducer auto-manages SSH config (initializes when an SSH location is selected, nulls when removed).

## Conventions

- All Rust models derive `Debug, Clone, Serialize, Deserialize, PartialEq`
- UUIDs are generated server-side in `JobService::create_job` (client sends a placeholder)
- Timestamps use `chrono::DateTime<Utc>` in Rust, ISO strings in TypeScript
- shadcn/ui components live in `src/components/ui/` (do not modify these)
- Path alias: `@/` maps to `src/` in both TypeScript and Vite config
- Error types use `thiserror` in Rust; Tauri commands convert errors to `String` for IPC

## Testing

Tests live in `crates/rsync-core/src/tests/`. They use:
- `TestFileSystem`: in-memory filesystem with inode tracking for hard-link simulation
- `TestRsyncClient`: simulates rsync semantics (--delete, --link-dest, --exclude, --backup-dir, --dry-run)
- `tempfile` crate for SQLite tests (creates temp DB per test)

Run all tests with `cargo test -p rsync-core`.

## What Not to Do

- Do not modify files in `src/components/ui/` — these are generated by shadcn
- Do not add logic to `src-tauri/` or `crates/rsync-commander/` that belongs in `rsync-core` — keep both frontend crates as thin shells
- Do not use `unwrap()` in production Rust code — use `?` or proper error handling
- Do not add dependencies to `src-tauri/Cargo.toml` unless they are Tauri/GUI-specific
- Do not add dependencies to `crates/rsync-commander/Cargo.toml` unless they are TUI-specific (ratatui, crossterm, clap)
